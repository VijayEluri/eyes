#{extends 'main.html' /}
#{set title:'Information' /}

#{set 'moreScripts'}
  
<script type="text/html" charset="utf-8" id="probe_HTTP">
  <hr />
  
  #{field 'server'}
  <input type="hidden" name="${field.name}" value="${instance.id}" id="${field.name}">
  #{/field}
  
  <p>
    #{field 'name'}
    <input type="text" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.name'}</label>
    #{/field}
  </p>
  
  <p>
    #{field 'serverURL'}
    <input type="text" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.http.serverURL'}</label>
    #{/field}
  </p>
  
  <p>
    #{field 'expectResponse'}
    <input type="text" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.http.expectResponse'}</label>
    #{/field}
  </p>
  <hr/>
  <p class="input-submit"><input type="submit" value="&{'probe.create'}"></p>
</script>

<script type="text/html" charset="utf-8" id="probe_IMAP">
  <hr />

  #{field 'server'}
  <input type="hidden" name="${field.name}" value="${instance.id}" id="${field.name}">
  #{/field}
  
  <p>
    #{field 'name'}
    <input type="text" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.name'}</label>
    #{/field}
  </p>
  
  <p>
    #{field 'address'}
    <input type="text" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.imap.address'}</label>
    #{/field}
  </p>
  
  <p>
    #{field 'username'}
    <input type="text" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.imap.username'}</label>
    #{/field}
  </p>
  
  <p>
    #{field 'password'}
    <input type="password" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.imap.password'}</label>
    #{/field}
  </p>
  <hr />  
  <p class="input-submit"><input type="submit" value="&{'probe.create'}"></p>
</script>

<script type="text/html" charset="utf-8" id="probe_SMTP">
  <hr />

  #{field 'server'}
  <input type="hidden" name="${field.name}" value="${instance.id}" id="${field.name}">
  #{/field}

  <p>
    #{field 'name'}
    <input type="text" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.name'}</label>
    #{/field}
  </p>
  
  <p>
    #{field 'recipient'}
    <input type="text" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.smtp.recipient'}</label>
    #{/field}
  </p>
  
  <p>
    #{field 'sender'}
    <input type="text" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.smtp.sender'}</label>
    #{/field}
  </p>
  
  <p>
    #{field 'address'}
    <input type="text" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.smtp.address'}</label>
    #{/field}
  </p>
  
  <p>
    #{field 'username'}
    <input type="text" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.smtp.username'}</label>
    #{/field}
  </p>
  
  <p>
    #{field 'password'}
    <input type="password" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.smtp.password'}</label>
    #{/field}
  </p>
  <hr />  
  <p class="input-submit"><input type="submit" value="&{'probe.create'}"></p>
</script>

<script type="text/html" charset="utf-8" id="probe_SSHLogin">
  <hr />

  #{field 'server'}
  <input type="hidden" name="${field.name}" value="${instance.id}" id="${field.name}">
  #{/field}

  <p>
    #{field 'name'}
    <input type="text" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.name'}</label>
    #{/field}
  </p>
  
  <p>
    #{field 'address'}
    <input type="text" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.sshlogin.address'}</label>
    #{/field}
  </p>
  
  <p>
    #{field 'username'}
    <input type="text" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.sshlogin.username'}</label>
    #{/field}
  </p>
  
  <p>
    #{field 'password'}
    <input type="password" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.sshlogin.password'}</label>
    #{/field}
  </p>
  <hr />  
  <p class="input-submit"><input type="submit" value="&{'probe.create'}"></p>
</script>

<script type="text/html" charset="utf-8" id="probe_HTTPForm">
  <hr />

  #{field 'server'}
  <input type="hidden" name="${field.name}" value="${instance.id}" id="${field.name}">
  #{/field}  
  
  <p>
    #{field 'name'}
    <input type="text" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.name'}</label>
    #{/field}
  </p>
  
  <p>
    #{field 'serverURL'}
    <input type="text" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.http.serverURL'}</label>
    #{/field}
  </p>
  
  <p>
    #{field 'expectResponse'}
    <input type="text" name="${field.name}" id="${field.id}" class="input-text" size="22">
    <label for="${field.name}">&{'probe.http.expectResponse'}</label>
    #{/field}
  </p>
  <hr />
    <span id="http-form-add-param" class="form-menu">
      <img src="/public/images/system-save.png" />
      Add parameter
    </span>
    <ul id="http-form-params">
    </ul>
  <hr />
  <p class="input-submit"><input type="submit" value="&{'probe.create'}"></p>
</script>

<script type="text/html" charset="utf-8" id="http_param_form">
  <p id="http-form-param-<%=index%>">
    <img id="http-form-delete-param-<%=index%>" class="form-menu" src="/public/images/system-delete.png" />
    
    #{field 'keys'}
    <input type="text" name="${field.name}" id="${field.name}" class="short">
    <label for="${field.name}">&{'probe.http.form.name'}</label>
    #{/field}
  
    #{field 'values'}
    <input type="text" name="${field.name}" id="${field.name}" class="short">
    <label for="${field.name}">&{'probe.http.form.value'}</label>
    #{/field}
    
  </p>
</script>

<script type="text/html" charset="utf-8" id="status_pie_message">
  Normally: <%=normally%> Problem: <%=problem%>
</script>

<script type="text/javascript" charset="utf-8">
  $(function() {
    var totalParam = 0
    
    this.show_form = function show_form(name) {
      $('.probe-form').hide()
      $('.responder-form').hide()
      $('.settings-form').hide()
      $('.graph-form').hide()
      $('.error').hide()
      
      $('.' + name + '-form').show()
    }
    
    this.show_chart = function show_chart() {
      var down = 0
      var up = 1
      
      var eventCountAction = #{jsAction @Servers.eventCount(instance.id, ':status') /}
      $.get(eventCountAction({status: 'DOWN'}), function(data) {
        down = data
        $.get(eventCountAction({status: 'UP'}), function (data) {
          up = data
          
          var status = [up, down]
          $('.status-pie').sparkline(status, {type: 'pie', sliceColors: ['#008000', '#D50000'], height: '150px'})
          $('.status-message').html(tmpl('status_pie_message', {normally: up, problem: down}))
        })
      })      
    }
    
    $('#probe-type').change(function(event) {
      var type = event.target.value
      if (type != 'none') {
        totalParam = 0
        var action = '/' + type + 'Probes/create'

        $('#probe-create-form').html(tmpl('probe_' + type))
        $('#probe-create-form').attr('action', action)
        
        $('#http-form-add-param').click(function(event) {
          var formID = '#http-form-param-' + totalParam
          $('#http-form-params').append(tmpl('http_param_form', {index: totalParam}))
          $('#http-form-delete-param-' + totalParam).click(function(event) {
            $(formID).remove()
          })
          totalParam++
        })
      } else {
        $('#probe-create-form').html('')
        $('#probe-create-form').attr('action', '')
      }
    })
    
    $('#probe-form-menu').click(function() { document.show_form('probe') })
    $('#responder-form-menu').click(function() { document.show_form('responder') })
    $('#settings-form-menu').click(function() { document.show_form('settings') })
    $('#graph-form-menu').click(function() { document.show_form('graph') })
    
    $('#logs').dataTable({
      "bProcessing": true,
      "bPaginate": true,
      "bFilter": false,
      "bSort": false,
      "bServerSide": true,
      "sPaginationType": "full_numbers",
      "bAutoWidth": false,
      "sAjaxSource": "@{Servers.events(instance.id)}",
      "fnRowCallback": function(nRow, aData, iDisplayIndex) {
        if (aData[1] == "OK") {
          $(nRow).addClass("green")
        } else {
          $(nRow).addClass("red")
        }
        return nRow
      }
    })
    
    
    var hash = "probe"
    if (document.location.hash.length > 0) {
      var hash = document.location.hash.substring(1)
    }

    this.show_form(hash)
    $('.error').show()
    
    this.show_chart()
  })
</script>

#{/set}

<div class="post entry">
  <a id="probe-form-menu" href="#probe">Probe</a> | 
  <a id="responder-form-menu" href="#responder">Responder</a> |
  <a id="graph-form-menu" href="#graph">Graph</a> |
  <a id="settings-form-menu" href="#settings">Settings</a>
</div>

#{secure.check 'user'}
#{if quota.canCreateProbe(instance)}
<div class="probe-form" id="genericform">
  
  <h3>&{'probe.create'}</h3>
  
  #{validation /}
  
  <label for="type">&{'probe.select'}</label>
  <select name="type" id="probe-type">
    <option value="none">&{'probe.select.help'}</option>
    #{list items:types, as:'type'}
    <option value="${type}">&{type}</option>
    #{/list}
  </select>
  
  <form id="probe-create-form" method="post" accept-charset="utf-8">
  </form>
</div>  
#{/if}
#{/secure.check}

<div class="post entry probe-form">
  
  <h2>&{'server.probe'}</h2>
  
  <ul>
  #{list items:probes, as:'probe'}
    <li>
      #{if probe.status() && probe.status().success}
        #{if probe.status().success}
        <img class="status" src="/public/images/Done Square.png" />
        #{/if}
        #{else}
        <img class="status" src="/public/images/Caution.png" />
        #{/else}
      #{/if}
      #{else}
      <img class="status" src="/public/images/Caution.png" />
      #{/else}
      ${probe.name()} (${probe.type()}) - 
      <a href="/${probe.type()}Probes/delete?server=${instance.id}&probe=${probe.id}">&{'probe.delete'}</a> | 
      <a href="/${probe.type()}Probes/check?server=${instance.id}&probe=${probe.id}">&{'probe.check'}</a> | 
      #{if probe.disable()}
        <a href="@{Probes.disable(instance.id, probe.type(), probe.getId(), false)}">enable</a>
      #{/if}
      #{else}
        <a href="@{Probes.disable(instance.id, probe.type(), probe.getId(), true)}">disable</a>
      #{/else}
    </li>
  #{/list}
  </ul>
  
</div>

#{secure.check 'user'}
#{if quota.canInviteResponder(instance)}
<div id="genericform" class="responder-form">

  <h3>&{'responder.add'}</h3>

  #{validation /}

  <form name="add-responder-form" action="@{Responders.create}" method="post" accept-charset="utf-8">

    #{field 'server'}
    <input type="hidden" name="${field.name}" value="${instance.id}" id="${field.name}">
    #{/field}

    <p>
      #{field 'email'}
      <input type="text" name="${field.name}" id="${field.id}" class="input-text" size="22">
      <label for="${field.name}">&{'email'}</label>
      #{/field}
    </p>

    <p class="input-submit"><input type="submit" value="&{'responder.add'}"></p>
  </form>

</div>  
#{/if}
#{/secure.check}

<div class="post entry responder-form">
  <h2>&{'server.responders'}</h2>
  
  <ul>
  #{list items:responders, as:'responder'}
    <li>
      #{if responder.username != controllers.Security.connected()}
      #{secure.check 'user'}
      <a href="@{Responders.delete(instance.id, responder.id)}">
        <img class="form-menu" src="/public/images/system-delete.png" />
      </a>
      #{/secure.check}
      #{/if}
      ${responder.username} (${responder.email})
    </li>
  #{/list}
  </ul>
</div>

<div class="post entry responder-form">
  <h2>&{'server.responders.waiting'}</h2>
  
  <ul>
  #{list items:invites, as:'invite'}
  <li>
    #{secure.check 'user'}
    <a href="@{Invites.delete(instance.id, invite.id)}">
      <img class="form-menu" src="/public/images/system-delete.png" />
    </a>
    #{/secure.check}
    ${invite.email}
  </li>
  #{/list}
  </ul>
</div>

<div id="genericform" class="graph-form">
  <span class="status-pie"></span>
  <span class="status-message"></span>
</div>

<div id="genericform" class="graph-form">
  <table border="0" cellspacing="5" cellpadding="5" id="logs">
    <thead>
      <tr>
        <th>Date</th>
        <th>Status</th>
        <th>Message</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td colspan="3">Loading data from server</td>
      </tr>
    </tbody>
  </table>
</div>

#{secure.check 'user'}
<div id="genericform" class="settings-form">

  <h3>&{'server.settings'}</h3>

  #{validation /}

  <form name="settings-form" action="@{Servers.saveSettings}" method="post" accept-charset="utf-8">

    #{field 'server'}
    <input type="hidden" name="${field.name}" value="${instance.id}" id="${field.name}">
    #{/field}

    <p>
      #{field 'alertWhenAllFail'}
      <input type="checkbox" name="${field.name}" value="true" #{if instance.alertWhenAllFail}checked#{/if} class="normal" />
      <label for="${field.name}">&{'server.settings.alertWhenAllFail'}</label>
      #{/field}
    </p>

    <p class="input-submit"><input type="submit" value="&{'server.settings.save'}"></p>
  </form>

</div>
#{/secure.check}